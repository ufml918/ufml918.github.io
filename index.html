<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Choose Your Own Adventure ‚Äì Birthday Edition</title>
  <style>
    :root { --bg:#0f172a; --panel:#111827; --card:#0b1220; --ink:#e5e7eb; --muted:#94a3b8; --accent:#38bdf8; }
    html,body{height:100%}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial; background:radial-gradient(1000px 800px at 10% -10%, #1f2937 0, #0b1020 40%, #050812 100%); color:var(--ink)}
    .wrap{max-width:960px;margin:32px auto;padding:0 16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px}
    h1{font-size:clamp(1.1rem,3vw,1.6rem);margin:0;font-weight:700;letter-spacing:.3px}
    .pill{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(180deg,#0b1324,#070a14);border:1px solid #1f2937;border-radius:999px;padding:8px 12px;color:var(--muted)}
    .row{display:flex;gap:16px;align-items:stretch}
    .col{flex:1}
    .panel{background:linear-gradient(180deg,#0b1324,#070a14);border:1px solid #1f2937;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);padding:16px}
    .panel h2{margin:0 0 8px 0;font-size:1rem;color:var(--muted);font-weight:600}
    textarea{width:100%;min-height:260px;background:#050a16;color:var(--ink);border:1px solid #1f2937;border-radius:12px;padding:12px;resize:vertical;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:.95rem;line-height:1.4}
    .btns{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    button{appearance:none;border:1px solid #1f2937;background:linear-gradient(180deg,#0c162a,#08101f);color:var(--ink);padding:10px 12px;border-radius:12px;font-weight:600;cursor:pointer}
    button:hover{border-color:#334155}
    button.accent{background:linear-gradient(180deg,#0284c7,#0369a1);border-color:#0ea5e9}
    button.ghost{background:transparent}
    .muted{color:var(--muted);font-size:.9rem}
    .player{display:flex;flex-direction:column;gap:12px}
    .card{background:linear-gradient(180deg,#0a1428,#091124);border:1px solid #1f2937;border-radius:16px;padding:16px}
    .title{font-size:1.1rem;font-weight:700;margin:0 0 4px}
    .text{white-space:pre-wrap;line-height:1.6}
    .choices{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .choice{display:block;text-align:left}
    .toolbar{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .breadcrumbs{display:flex;flex-wrap:wrap;gap:6px}
    .crumb{font-size:.8rem;color:var(--muted);background:#0b1220;border:1px dashed #1f2937;border-radius:999px;padding:4px 8px}
    .hidden{display:none}
    .img-wrap{border-radius:12px;overflow:hidden;border:1px solid #1f2937}
    img{max-width:100%;display:block}
    @media (max-width:860px){.row{flex-direction:column}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>üéÇ Birthday CYOA</h1>
      <div class="pill">
        <span id="mode-label">Edit Mode</span>
        <button id="toggle-mode" class="ghost" title="Toggle editor / player">Toggle</button>
      </div>
    </header>

    <div id="editor" class="row">
      <div class="col panel">
        <h2>‚úçÔ∏è Paste your story JSON</h2>
        <textarea id="story-input" spellcheck="false"></textarea>
        <div class="btns">
          <button id="validate" class="accent">Validate & Start ‚ñ∂</button>
          <button id="import-json">Import JSON</button>
          <button id="export-json">Export JSON</button>
          <button id="copy-share">Copy Play Link</button>
          <button id="load-sample" title="Load a tiny demo story">Load Example</button>
        </div>
        <p class="muted">Schema: <code>{ title, start, nodes: { [id]: { text, image?, end?, choices?: [{label,to}] } } }</code>. Use <code>end:true</code> to mark an ending.</p>
      </div>
    </div>

    <div id="player" class="player hidden">
      <div class="toolbar">
        <div class="breadcrumbs" id="crumbs"></div>
        <div>
          <button id="back">‚Üê Back</button>
          <button id="restart" class="ghost">‚ü≤ Restart</button>
        </div>
      </div>
      <div class="card">
        <div class="img-wrap hidden" id="img-wrap"><img id="node-img" alt=""/></div>
        <h3 class="title" id="story-title">Your Adventure</h3>
        <div class="text" id="node-text"></div>
        <div class="choices" id="choices"></div>
      </div>
    </div>
  </div>

  <script>
    const $ = (id)=>document.getElementById(id);
    const state = { story:null, current:null, history:[] };

    function setMode(mode){
      if(mode==='play'){
        $('editor').classList.add('hidden');
        $('player').classList.remove('hidden');
        $('mode-label').textContent='Play Mode';
      } else {
        $('editor').classList.remove('hidden');
        $('player').classList.add('hidden');
        $('mode-label').textContent='Edit Mode';
      }
    }

    function validateStory(raw){
      let story;
      try{ story = JSON.parse(raw); }catch(e){ throw new Error('Invalid JSON: '+e.message); }
      if(!story || typeof story!=='object') throw new Error('Story must be an object.');
      if(typeof story.title!=='string') throw new Error('Missing string "title"');
      if(typeof story.start!=='string') throw new Error('Missing string "start" node id');
      if(!story.nodes || typeof story.nodes!=='object') throw new Error('Missing "nodes" map');
      if(!story.nodes[story.start]) throw new Error('Start node "'+story.start+'" not found');
      for(const [id,node] of Object.entries(story.nodes)){
        if(!node || typeof node!=='object') throw new Error('Node '+id+' must be an object');
        if(typeof node.text!=='string') throw new Error('Node '+id+' missing string "text"');
        if(node.choices){
          if(!Array.isArray(node.choices)) throw new Error('Node '+id+' choices must be an array');
          for(const c of node.choices){
            if(typeof c.label!=='string' || typeof c.to!=='string') throw new Error('Node '+id+' has invalid choice {label,to}');
            if(!story.nodes[c.to]) throw new Error('Choice from '+id+' points to missing node "'+c.to+'"');
          }
        }
      }
      return story;
    }

    function render(){
      const node = state.story.nodes[state.current];
      $('story-title').textContent = state.story.title;
      $('node-text').textContent = node.text;
      if(node.image){
        $('img-wrap').classList.remove('hidden');
        $('node-img').src = node.image;
      } else {
        $('img-wrap').classList.add('hidden');
        $('node-img').removeAttribute('src');
      }
      const crumbs = state.history.concat(state.current).map(id=>`<span class="crumb">${id}</span>`).join('');
      $('crumbs').innerHTML = crumbs;
      const box = $('choices');
      box.innerHTML = '';
      const isEnd = !!node.end || !node.choices || node.choices.length===0;
      if(isEnd){
        const b = document.createElement('button');
        b.textContent = 'üéâ The End ‚Äî Play Again';
        b.className='choice';
        b.onclick = restart;
        box.appendChild(b);
      } else {
        for(const c of node.choices){
          const btn = document.createElement('button');
          btn.className='choice';
          btn.textContent = '‚Ä¢ ' + c.label;
          btn.onclick = () => go(c.to);
          box.appendChild(btn);
        }
      }
    }

    function go(nextId){
      state.history.push(state.current);
      state.current = nextId;
      render();
    }

    function back(){
      if(state.history.length===0) return;
      state.current = state.history.pop();
      render();
    }

    function restart(){
      state.history = [];
      state.current = state.story.start;
      render();
    }

    function exportJSON(){
      const blob = new Blob([$('story-input').value], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = (state.story?.title || 'cyoa') + '.json';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function importJSON(){
      const input = document.createElement('input');
      input.type='file'; input.accept='.json,application/json';
      input.onchange = () => {
        const file = input.files[0]; if(!file) return;
        file.text().then(txt=>{ $('story-input').value = txt; });
      };
      input.click();
    }

    function makeShareLink(){
      const raw = $('story-input').value.trim();
      try{ validateStory(raw); }catch(e){ alert('Fix story before sharing: '+e.message); return; }
      const enc = encodeURIComponent(raw);
      const url = location.origin + location.pathname + '#story=' + enc;
      navigator.clipboard.writeText(url).then(()=> alert('Play link copied to clipboard!'));
    }

    function tryLoadFromHash(){
      if(location.hash.startsWith('#story=')){
        const raw = decodeURIComponent(location.hash.slice(7));
        try{
          const story = validateStory(raw);
          state.story = story; state.current = story.start; state.history=[]; setMode('play'); render();
        }catch(e){ console.error(e); }
      }
    }

    $('toggle-mode').onclick = ()=>{
      const isEdit = !$('editor').classList.contains('hidden');
      setMode(isEdit?'play':'edit');
    };

    $('validate').onclick = ()=>{
      const raw = $('story-input').value.trim();
      try{
        const story = validateStory(raw);
        state.story = story; state.current = story.start; state.history=[];
        setMode('play'); render();
      }catch(e){ alert(e.message); }
    };

    $('back').onclick = back;
    $('restart').onclick = restart;
    $('export-json').onclick = exportJSON;
    $('import-json').onclick = importJSON;
    $('copy-share').onclick = makeShareLink;

    $('load-sample').onclick = ()=>{
      const sample = {
        title:"Happy Birthday, Explorer!",
        start:"start",
        nodes:{
          start:{ text:"It's your birthday! A glowing gift appears with a tag: 'Open me?'.", choices:[{label:"Open it", to:"gift"},{label:"Wait and look around", to:"look"}] },
          gift:{ text:"Confetti explodes! Inside is a clue leading to cake.", choices:[{label:"Follow the clue", to:"cake"},{label:"Save it for later", to:"look"}] },
          look:{ text:"You notice two doors: one marked 'Memories', one 'Surprises'.", choices:[{label:"Memories", to:"mem"},{label:"Surprises", to:"surp"}] },
          mem:{ text:"A slideshow of your favorite moments plays. ü•π", end:true },
          surp:{ text:"Friends shout 'Happy Birthday!' from behind the couch! üéâ", end:true },
          cake:{ text:"You find the cake with your name on it. Make a wish! ‚ú®", end:true }
        }
      };
      $('story-input').value = JSON.stringify(sample, null, 2);
    };

    tryLoadFromHash();
  </script>
</body>
</html>
